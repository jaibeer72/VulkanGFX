name: Build on Windows

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest
    env:
      VCPKG_DEFAULT_TRIPLET: x64-windows

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        submodules: true

    - name: Install vcpkg dependencies
      run: .\vcpkg\bootstrap-vcpkg.bat

    - name: Install vcpkg packages (manifest + explicit triplet)
      run: .\vcpkg\vcpkg install --triplet=x64-windows
    - name: Verify vcpkg installed packages
      run: .\vcpkg\vcpkg list | findstr /R "glm glfw3 vulkan" || true

    - name: Configure CMake using presets
      run: cmake --preset VisualStudio

    - name: Build with CMake preset
      run: cmake --build --preset VisualStudio:Debug

    - name: Find and run built executable (if present)
      shell: bash
      run: |
        set -e
        # windows runner uses powershell by default, but here we use bash from Git for Windows
        exe=$(find out/build -type f -name VulkanGFX.exe -print -quit || true)
        if [[ -n "$exe" ]]; then
          echo "Running $exe"
          "$exe" || true
        else
          echo "No VulkanGFX.exe found in build; listing files";
          find out/build -maxdepth 4 -type f -name "*VulkanGFX*" -print || true
        fi